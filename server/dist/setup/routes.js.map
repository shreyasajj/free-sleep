{"version":3,"file":"routes.js","sources":["setup/routes.ts"],"sourceRoot":"/","sourcesContent":["import * as Sentry from '@sentry/node';\n\nimport express, { Express, Request, Response, NextFunction } from 'express';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport deviceStatus from '../routes/deviceStatus/deviceStatus.js';\nimport alarm from '../routes/alarm/alarm.js';\nimport execute from '../routes/execute/execute.js';\nimport jobs from '../routes/jobs/jobs.js';\nimport settings from '../routes/settings/settings.js';\nimport services from '../routes/services/services.js';\nimport schedules from '../routes/schedules/schedules.js';\nimport sleep from '../routes/metrics/sleep.js';\nimport movement from '../routes/metrics/movement.js';\nimport vitals from '../routes/metrics/vitals.js';\nimport presence from '../routes/metrics/presence.js';\nimport logs from '../routes/logs/logs.js';\nimport serverStatus from '../routes/serverStatus/serverStatus.js';\nimport logger from '../logger.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nexport default function (app: Express) {\n  logger.debug('Registering routes...');\n  app.use('/api/', alarm);\n  app.use('/api/', deviceStatus);\n  app.use('/api/', execute);\n  app.use('/api/', schedules);\n  app.use('/api/', jobs);\n  app.use('/api/', settings);\n  app.use('/api/', services);\n  app.use('/api/metrics/', movement);\n  app.use('/api/metrics/', sleep);\n  app.use('/api/metrics/', vitals);\n  app.use('/api/metrics/', presence);\n  app.use('/api/logs', logs);\n  app.use('/api/serverStatus', serverStatus);\n  app.use('/api', (req: Request, res: Response) => {\n    res.status(404).json({ error: { message: 'Not Found' } });\n  });\n\n\n  // --- JSON parse / body parser errors (normalize to 400)\n  app.use((err: any, _req: Request, res: Response, next: NextFunction) => {\n    // If this isn't a body-parse error, pass it on to the central handler\n    if (!err || err.type !== 'entity.parse.failed') return next(err);\n    res.status(400).json({ error: { message: 'Invalid JSON' } });\n  });\n  Sentry.setupExpressErrorHandler(app);\n\n  // --- Central error handler (must be AFTER routes and special-case handlers)\n  // eslint-disable-next-line no-unused-vars,@typescript-eslint/no-unused-vars\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const isProd = process.env.NODE_ENV === 'production';\n    const status = Number(err?.status) || 500;\n    const body: any = { error: { message: err?.message || 'Internal Server Error' } };\n    if (!isProd) body.error.stack = err?.stack;\n    logger.error(body);\n    logger.error(JSON.stringify(body));\n    res.status(status).json(body);\n  });\n\n  // --- Static files for the SPA\n  app.use(express.static(path.join(__dirname, '../../public')));\n\n  // --- SPA catch-all (MUST be last)\n  app.get('/{*splat}', (_req, res) => {\n    res.sendFile(path.resolve(__dirname, '../../public', 'index.html'));\n  });\n  logger.debug('Registered routes!');\n}"],"names":[],"mappings":"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","debug_id":"ca07c08e-ac96-5992-9ca4-451a00415d21"}