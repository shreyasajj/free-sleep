{"version":3,"file":"presence.js","sources":["routes/metrics/presence.ts"],"sourceRoot":"/","sourcesContent":["import express, { Request, Response, Router } from 'express';\n\nconst router: Router = express.Router();\n\n// ============================================================\n// CONFIGURATION\n// ============================================================\n// How long before presence data is considered stale (in milliseconds)\n// Default: 10 minutes (600000 ms)\nconst STALE_DATA_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes\n// ============================================================\n\n// Interface for presence data structure\ninterface PresenceData {\n  left: boolean | null;\n  right: boolean | null;\n  lastUpdated: {\n    left: number | null;\n    right: number | null;\n  };\n}\n\n// In-memory storage for presence data\n// Default values are null until first update\nconst presenceData: PresenceData = {\n  left: null,\n  right: null,\n  lastUpdated: {\n    left: null,\n    right: null\n  }\n};\n\n// Helper function to check if data is stale\nconst isDataStale = (timestamp: number | null): boolean => {\n  if (!timestamp) return true;\n  return Date.now() - timestamp > STALE_DATA_TIMEOUT_MS;\n};\n\n/**\n * POST /presence\n * Update presence data for one or both sides\n * \n * Body examples:\n * - { \"left\": true } - Update left side only\n * - { \"right\": false } - Update right side only\n * - { \"left\": true, \"right\": false } - Update both sides\n * - {} - No side specified (invalid, returns 400)\n */\nrouter.post('/presence', (req: Request, res: Response) => {\n  try {\n    const { left, right } = req.body;\n    \n    // Check if at least one side is provided\n    if (left === undefined && right === undefined) {\n      return res.status(400).json({\n        error: 'At least one side (left or right) must be specified',\n        message: 'Please provide \"left\" and/or \"right\" with boolean values'\n      });\n    }\n    \n    const currentTime = Date.now();\n    \n    // Update left side if provided\n    if (left !== undefined) {\n      if (typeof left !== 'boolean') {\n        return res.status(400).json({\n          error: 'Invalid value for left',\n          message: 'Value must be a boolean (true or false)'\n        });\n      }\n      presenceData.left = left;\n      presenceData.lastUpdated.left = currentTime;\n    }\n    \n    // Update right side if provided\n    if (right !== undefined) {\n      if (typeof right !== 'boolean') {\n        return res.status(400).json({\n          error: 'Invalid value for right',\n          message: 'Value must be a boolean (true or false)'\n        });\n      }\n      presenceData.right = right;\n      presenceData.lastUpdated.right = currentTime;\n    }\n    \n    return res.status(200).json({\n      success: true,\n      message: 'Presence data updated',\n      data: {\n        left: presenceData.left,\n        right: presenceData.right,\n        lastUpdated: presenceData.lastUpdated\n      }\n    });\n    \n  } catch (error) {\n    console.error('Error updating presence:', error);\n    return res.status(500).json({\n      error: 'Internal server error',\n      message: (error as Error).message\n    });\n  }\n});\n\n/**\n * GET /presence\n * Get presence data for one or both sides\n * \n * Query parameters:\n * - ?side=left - Get left side presence only\n * - ?side=right - Get right side presence only\n * - (no params) - Get overall presence (true if either side has presence)\n */\nrouter.get('/presence', (req: Request, res: Response) => {\n  try {\n    const { side } = req.query;\n    \n    // Check if data is available (not null and not stale)\n    const isLeftAvailable = presenceData.left !== null && !isDataStale(presenceData.lastUpdated.left);\n    const isRightAvailable = presenceData.right !== null && !isDataStale(presenceData.lastUpdated.right);\n    \n    // If specific side is requested\n    if (side === 'left') {\n      if (!isLeftAvailable) {\n        return res.status(200).json({\n          side: 'left',\n          presence: 'not available',\n          message: 'No recent data available for left side'\n        });\n      }\n      \n      return res.status(200).json({\n        side: 'left',\n        presence: presenceData.left,\n        lastUpdated: presenceData.lastUpdated.left\n      });\n    }\n    \n    if (side === 'right') {\n      if (!isRightAvailable) {\n        return res.status(200).json({\n          side: 'right',\n          presence: 'not available',\n          message: 'No recent data available for right side'\n        });\n      }\n      \n      return res.status(200).json({\n        side: 'right',\n        presence: presenceData.right,\n        lastUpdated: presenceData.lastUpdated.right\n      });\n    }\n    \n    // No side specified - return overall presence\n    // Overall presence is true if either side has presence\n    if (!isLeftAvailable && !isRightAvailable) {\n      return res.status(200).json({\n        side: 'all',\n        presence: 'not available',\n        message: 'No recent data available for either side'\n      });\n    }\n    \n    // If only one side has data, use that\n    let overallPresence: boolean;\n    if (isLeftAvailable && !isRightAvailable) {\n      overallPresence = presenceData.left as boolean;\n    } else if (!isLeftAvailable && isRightAvailable) {\n      overallPresence = presenceData.right as boolean;\n    } else {\n      // Both sides have data - presence if either side is true\n      overallPresence = (presenceData.left as boolean) || (presenceData.right as boolean);\n    }\n    \n    return res.status(200).json({\n      side: 'all',\n      presence: overallPresence,\n      details: {\n        left: isLeftAvailable ? presenceData.left : 'not available',\n        right: isRightAvailable ? presenceData.right : 'not available'\n      },\n      lastUpdated: {\n        left: presenceData.lastUpdated.left,\n        right: presenceData.lastUpdated.right\n      }\n    });\n    \n  } catch (error) {\n    console.error('Error retrieving presence:', error);\n    return res.status(500).json({\n      error: 'Internal server error',\n      message: (error as Error).message\n    });\n  }\n});\n\nexport default router;"],"names":[],"mappings":"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","debug_id":"e9007459-fa0f-56e9-abb5-dd7a8c95eafe"}