{"version":3,"file":"presence.js","sources":["routes/metrics/presence.ts"],"sourceRoot":"/","sourcesContent":["import express, { Request, Response, Router } from 'express';\nimport moment from 'moment-timezone';\n\nconst router: Router = express.Router();\n\n// ============================================================\n// CONFIGURATION\n// ============================================================\n// How long before presence data is considered stale (in milliseconds)\n// Default: 10 minutes (600000 ms)\nconst STALE_DATA_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes\n// ============================================================\n\n// Interface for side presence data\ninterface SidePresent {\n  present: boolean;\n  lastUpdatedAt: string; // Human readable timestamp with moment.tz().format()\n  isStale: boolean;\n}\n\n// Interface for complete presence data\ninterface PresenceData {\n  left: SidePresent;\n  right: SidePresent;\n}\n\n// In-memory storage for presence data\n// Default values are null until first update\nlet presenceData = {\n  left: null as boolean | null,\n  right: null as boolean | null,\n  lastUpdated: {\n    left: null as number | null,\n    right: null as number | null\n  }\n};\n\n// Helper function to check if data is stale\nconst isDataStale = (timestamp: number | null): boolean => {\n  if (!timestamp) return true;\n  return Date.now() - timestamp > STALE_DATA_TIMEOUT_MS;\n};\n\n// Helper function to format side data\nconst formatSideData = (present: boolean | null, timestamp: number | null): SidePresent => {\n  const stale = isDataStale(timestamp);\n  return {\n    present: present ?? false,\n    lastUpdatedAt: timestamp ? moment(timestamp).utc().format() : 'never',\n    isStale: stale\n  };\n};\n\n/**\n * POST /presence\n * Update presence data for one or both sides\n * \n * Body examples:\n * - { \"left\": true } - Update left side only\n * - { \"right\": false } - Update right side only\n * - { \"left\": true, \"right\": false } - Update both sides\n * - {} - No side specified (invalid, returns 400)\n */\nrouter.post('/presence', (req: Request, res: Response) => {\n  try {\n    const { left, right } = req.body;\n    \n    // Check if at least one side is provided\n    if (left === undefined && right === undefined) {\n      return res.status(400).json({\n        error: 'At least one side (left or right) must be specified',\n        message: 'Please provide \"left\" and/or \"right\" with boolean values'\n      });\n    }\n    \n    const currentTime = Date.now();\n    \n    // Update left side if provided\n    if (left !== undefined) {\n      if (typeof left !== 'boolean') {\n        return res.status(400).json({\n          error: 'Invalid value for left',\n          message: 'Value must be a boolean (true or false)'\n        });\n      }\n      presenceData.left = left;\n      presenceData.lastUpdated.left = currentTime;\n    }\n    \n    // Update right side if provided\n    if (right !== undefined) {\n      if (typeof right !== 'boolean') {\n        return res.status(400).json({\n          error: 'Invalid value for right',\n          message: 'Value must be a boolean (true or false)'\n        });\n      }\n      presenceData.right = right;\n      presenceData.lastUpdated.right = currentTime;\n    }\n    \n    return res.status(200).json({\n      success: true,\n      message: 'Presence data updated',\n      data: {\n        left: presenceData.left,\n        right: presenceData.right,\n        lastUpdated: presenceData.lastUpdated\n      }\n    });\n    \n  } catch (error) {\n    console.error('Error updating presence:', error);\n    return res.status(500).json({\n      error: 'Internal server error',\n      message: (error as Error).message\n    });\n  }\n});\n\n/**\n * GET /presence\n * Get presence data for both sides\n * \n * Query parameters:\n * - ?side=left - Get left side presence only (returns single SidePresent object)\n * - ?side=right - Get right side presence only (returns single SidePresent object)\n * - (no params) - Get both sides (returns PresenceData object)\n */\nrouter.get('/presence', (req: Request, res: Response) => {\n  try {\n    const { side } = req.query;\n    \n    // If specific side is requested, return just that side\n    if (side === 'left') {\n      return res.status(200).json(formatSideData(presenceData.left, presenceData.lastUpdated.left));\n    }\n    \n    if (side === 'right') {\n      return res.status(200).json(formatSideData(presenceData.right, presenceData.lastUpdated.right));\n    }\n    \n    // No side specified - return both sides\n    const response: PresenceData = {\n      left: formatSideData(presenceData.left, presenceData.lastUpdated.left),\n      right: formatSideData(presenceData.right, presenceData.lastUpdated.right)\n    };\n    \n    return res.status(200).json(response);\n    \n  } catch (error) {\n    console.error('Error retrieving presence:', error);\n    return res.status(500).json({\n      error: 'Internal server error',\n      message: (error as Error).message\n    });\n  }\n});\n\nexport default router;"],"names":[],"mappings":"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","debug_id":"c5554f32-dc08-5d0b-9088-1e380f2426d7"}